<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExifScan ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>

    <div class="container">
        <div class="nav">
            <a href="/settings.html">âš™ï¸ è®¾ç½®</a>
        </div>

        <h1>ExifScan</h1>

        <div class="card">
            <h2>å¼€å§‹æ‰«æ</h2>
            <div class="form-group">
                <label>æ‰«æç›®å½•</label>
                <div class="input-group">
                    <input type="text" id="scanPath" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„..." value="D:\Photos">
                    <button type="button" id="browseBtn">ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹</button>
                </div>
            </div>

            <button id="scanBtn" class="block">ğŸš€ å¼€å§‹æ‰«æ</button>

            <div id="message"></div>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <h2>æ‰«æç»“æœ</h2>
            <p id="resultText"></p>
        </div>
    </div>

    <!-- Directory Picker Modal -->
    <div id="dirModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">é€‰æ‹©æ–‡ä»¶å¤¹</h3>
                <span style="cursor:pointer; font-size:1.5rem;" id="closeModal">&times;</span>
            </div>
            <div style="padding: 10px 20px; background: #fafafa; border-bottom: 1px solid #eee;">
                å½“å‰: <span id="currentPath" style="font-family:monospace;"></span>
            </div>
            <div class="modal-body" id="fileList"></div>
            <div class="modal-footer">
                <button type="button" class="secondary" id="upDirBtn">â¬†ï¸ ä¸Šçº§ç›®å½•</button>
                <button type="button" id="selectDirBtn">âœ… é€‰æ‹©æ­¤ç›®å½•</button>
            </div>
        </div>
    </div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const msgDiv = document.getElementById('message');
        const resultCard = document.getElementById('resultCard');
        const resultText = document.getElementById('resultText');

        function showMessage(msg, isError = false) {
            msgDiv.style.display = 'block';
            msgDiv.className = isError ? 'error' : 'success';
            msgDiv.innerText = msg;
        }

        // --- Directory Picker Logic (Shared with Settings, kept inline for simplicity or could be extracted) ---
        const modal = document.getElementById('dirModal');
        const browseBtn = document.getElementById('browseBtn');
        const closeModal = document.getElementById('closeModal');
        const fileList = document.getElementById('fileList');
        const currentPathSpan = document.getElementById('currentPath');
        const upDirBtn = document.getElementById('upDirBtn');
        const selectDirBtn = document.getElementById('selectDirBtn');

        let currentPath = "";

        browseBtn.onclick = () => {
            modal.style.display = "block";
            let startPath = document.getElementById('scanPath').value || "";
            loadDir(startPath);
        }
        closeModal.onclick = () => modal.style.display = "none";
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

        function loadDir(path) {
            fetch(`/api/fs/list?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(files => {
                    if (files.error) {
                        // if error (e.g. empty path on windows -> drives), try empty
                        if (path !== "") loadDir("");
                        else alert("æ— æ³•è¯»å–: " + files.error);
                        return;
                    }
                    currentPath = path;
                    currentPathSpan.innerText = path || "æ­¤ç”µè„‘";

                    fileList.innerHTML = '';
                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        const icon = file.isDir ? 'ğŸ“' : 'ğŸ“„';
                        div.innerHTML = `<span class="file-icon">${icon}</span> ${file.name}`;
                        if (file.isDir) {
                            div.onclick = () => loadDir(file.path);
                        }
                        fileList.appendChild(div);
                    });
                })
                .catch(err => console.error(err));
        }

        upDirBtn.onclick = () => {
            if (!currentPath) return;
            // Simple parent logic
            if (currentPath.match(/^[a-zA-Z]:\\?$/)) { loadDir(""); return; }
            const separator = currentPath.includes('/') ? '/' : '\\';
            const parts = currentPath.split(separator).filter(p => p);
            parts.pop();
            if (parts.length === 1 && parts[0].match(/^[a-zA-Z]:$/)) loadDir(parts[0] + "\\");
            else if (parts.length === 0) loadDir("");
            else loadDir(parts.join(separator));
        };

        selectDirBtn.onclick = () => {
            if (currentPath === "") { alert("è¯·é€‰æ‹©å…·ä½“æ–‡ä»¶å¤¹"); return; }
            document.getElementById('scanPath').value = currentPath;
            modal.style.display = "none";
        };

        // --- Scan Logic ---
        scanBtn.addEventListener('click', () => {
            const path = document.getElementById('scanPath').value;
            if (!path) {
                showMessage("è¯·è¾“å…¥æˆ–é€‰æ‹©æ‰«æè·¯å¾„", true);
                return;
            }

            showMessage("æ­£åœ¨æ‰«æï¼Œè¯·ç¨å€™...");
            scanBtn.disabled = true;
            resultCard.style.display = 'none';

            fetch('/api/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            })
                .then(response => response.json())
                .then(data => {
                    scanBtn.disabled = false;
                    if (data.success) {
                        showMessage(`âœ… æ‰«æå®Œæˆ! å‘ç° ${data.count} å¼ å›¾ç‰‡ã€‚`);
                        resultText.innerText = data.message;
                        resultCard.style.display = 'block';
                    } else {
                        showMessage("âŒ æ‰«æå¤±è´¥: " + data.message, true);
                    }
                })
                .catch(error => {
                    scanBtn.disabled = false;
                    showMessage("âŒ è¯·æ±‚å‡ºé”™: " + error, true);
                });
        });

        // Load initial config path
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                if (data.scan && data.scan.path) {
                    document.getElementById('scanPath').value = data.scan.path;
                }
            });

    </script>

</body>

</html>