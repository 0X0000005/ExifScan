<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExifScan ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="container">
        <div class="nav">
            <a href="/settings.html">âš™ï¸ è®¾ç½®</a>
        </div>

        <h1>ğŸ“· ExifScan</h1>

        <div class="card">
            <h2>å¼€å§‹æ‰«æ</h2>
            <div class="form-group">
                <label>æ‰«æç›®å½•</label>
                <div class="input-group">
                    <input type="text" id="scanPath" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„...">
                    <button type="button" id="browseBtn">ğŸ“‚ é€‰æ‹©</button>
                </div>
            </div>

            <div class="action-bar">
                <button id="scanBtn" class="primary-action">ğŸš€ å¼€å§‹æ‰«æ</button>
                <button id="loadHistoryBtn" class="secondary-action">ğŸ“Š åŠ è½½å†å²</button>
                <label class="file-upload-label" for="importFile">ğŸ“¥ å¯¼å…¥JSON</label>
                <input type="file" id="importFile" accept=".json" style="display:none;">
            </div>

            <div id="message"></div>
        </div>

        <!-- ç»Ÿè®¡æ‘˜è¦ -->
        <div class="card" id="statsCard" style="display:none;">
            <h2>ğŸ“ˆ ç»Ÿè®¡æ¦‚è§ˆ</h2>
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-value" id="totalCount">0</span>
                    <span class="stat-label">æ€»å›¾ç‰‡æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="topModel">-</span>
                    <span class="stat-label">æœ€å¤šæœºå‹</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="topISO">-</span>
                    <span class="stat-label">æœ€å¤šISO</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="topFNumber">-</span>
                    <span class="stat-label">æœ€å¤šå…‰åœˆ</span>
                </div>
            </div>

            <div class="download-bar">
                <a href="/api/download/excel" class="download-btn" id="dlExcel">ğŸ“¥ ä¸‹è½½ Excel</a>
                <a href="/api/download/json" class="download-btn" id="dlJson">ğŸ“¥ ä¸‹è½½ JSON</a>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div id="chartsSection" style="display:none;">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>ğŸ“· ç›¸æœºå‹å·åˆ†å¸ƒ</h3>
                    <canvas id="modelChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ğŸ”† ISO åˆ†å¸ƒ</h3>
                    <canvas id="isoChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ğŸ”… å…‰åœˆåˆ†å¸ƒ</h3>
                    <canvas id="fnumberChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ğŸ”­ ç„¦è·åˆ†å¸ƒ</h3>
                    <canvas id="focalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="card" id="tableCard" style="display:none;">
            <div class="table-header">
                <h2>ğŸ“‹ æ•°æ®åˆ—è¡¨</h2>
                <button type="button" id="toggleTableBtn" class="secondary small">å±•å¼€/æ”¶èµ·</button>
            </div>
            <div id="tableWrapper" class="table-wrapper collapsed">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶</th>
                            <th>å¿«é—¨é€Ÿåº¦</th>
                            <th>ISO</th>
                            <th>å…‰åœˆ</th>
                            <th>ç„¦è·</th>
                            <th>æœºå‹</th>
                            <th>æ‹æ‘„æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Directory Picker Modal -->
    <div id="dirModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">é€‰æ‹©æ–‡ä»¶å¤¹</h3>
                <span style="cursor:pointer; font-size:1.5rem;" id="closeModal">&times;</span>
            </div>
            <div style="padding: 10px 20px; background: #fafafa; border-bottom: 1px solid #eee;">
                å½“å‰: <span id="currentPath" style="font-family:monospace;"></span>
            </div>
            <div class="modal-body" id="fileList"></div>
            <div class="modal-footer">
                <button type="button" class="secondary" id="upDirBtn">â¬†ï¸ ä¸Šçº§ç›®å½•</button>
                <button type="button" id="selectDirBtn">âœ… é€‰æ‹©æ­¤ç›®å½•</button>
            </div>
        </div>
    </div>

    <script>
        // ===== å…ƒç´ å¼•ç”¨ =====
        const scanBtn = document.getElementById('scanBtn');
        const loadHistoryBtn = document.getElementById('loadHistoryBtn');
        const importFile = document.getElementById('importFile');
        const msgDiv = document.getElementById('message');
        const statsCard = document.getElementById('statsCard');
        const chartsSection = document.getElementById('chartsSection');
        const tableCard = document.getElementById('tableCard');
        const tableWrapper = document.getElementById('tableWrapper');
        const toggleTableBtn = document.getElementById('toggleTableBtn');

        // Chart å®ä¾‹
        let modelChart, isoChart, fnumberChart, focalChart;

        // é¢œè‰²è°ƒè‰²æ¿
        const palette = [
            '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
            '#edc948', '#b07aa1', '#ff9da7', '#9c755f', '#bab0ac',
            '#86bcb6', '#8cd17d', '#b6992d', '#499894', '#e15759',
            '#f1ce63', '#d37295', '#a0cbe8', '#ffbe7d', '#d4a6c8'
        ];

        function showMessage(msg, isError = false) {
            msgDiv.style.display = 'block';
            msgDiv.className = isError ? 'error' : 'success';
            msgDiv.innerText = msg;
        }

        // ===== ç›®å½•é€‰æ‹©å™¨ =====
        const modal = document.getElementById('dirModal');
        const browseBtn = document.getElementById('browseBtn');
        const closeModal = document.getElementById('closeModal');
        const fileList = document.getElementById('fileList');
        const currentPathSpan = document.getElementById('currentPath');
        const upDirBtn = document.getElementById('upDirBtn');
        const selectDirBtn = document.getElementById('selectDirBtn');

        let currentPath = "";

        browseBtn.onclick = () => {
            modal.style.display = "block";
            let startPath = document.getElementById('scanPath').value || "";
            loadDir(startPath);
        }
        closeModal.onclick = () => modal.style.display = "none";
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

        function loadDir(path) {
            fileList.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">åŠ è½½ä¸­...</div>';
            fetch(`/api/fs/list?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(files => {
                    if (files.error) {
                        if (path !== "") loadDir("");
                        else alert("æ— æ³•è¯»å–: " + files.error);
                        return;
                    }
                    currentPath = path;
                    currentPathSpan.innerText = path || "æ­¤ç”µè„‘";

                    fileList.innerHTML = '';
                    if (files.length === 0) {
                        fileList.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æ— å­ç›®å½•</div>';
                        return;
                    }
                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `<span class="file-icon">ğŸ“</span> ${file.name}`;
                        div.onclick = () => loadDir(file.path);
                        fileList.appendChild(div);
                    });
                })
                .catch(err => console.error(err));
        }

        upDirBtn.onclick = () => {
            if (!currentPath) return;
            if (currentPath.match(/^[a-zA-Z]:\\?$/)) { loadDir(""); return; }
            const separator = currentPath.includes('/') ? '/' : '\\';
            const parts = currentPath.split(separator).filter(p => p);
            parts.pop();
            if (parts.length === 1 && parts[0].match(/^[a-zA-Z]:$/)) loadDir(parts[0] + "\\");
            else if (parts.length === 0) loadDir("");
            else loadDir(parts.join(separator));
        };

        selectDirBtn.onclick = () => {
            if (currentPath === "") { alert("è¯·é€‰æ‹©å…·ä½“æ–‡ä»¶å¤¹"); return; }
            document.getElementById('scanPath').value = currentPath;
            modal.style.display = "none";
        };

        // ===== æ‰«æé€»è¾‘ =====
        scanBtn.addEventListener('click', () => {
            const path = document.getElementById('scanPath').value;
            if (!path) {
                showMessage("è¯·è¾“å…¥æˆ–é€‰æ‹©æ‰«æè·¯å¾„", true);
                return;
            }

            showMessage("æ­£åœ¨æ‰«æï¼Œè¯·ç¨å€™...");
            scanBtn.disabled = true;
            hideResults();

            fetch('/api/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            })
                .then(response => response.json())
                .then(data => {
                    scanBtn.disabled = false;
                    if (data.success) {
                        showMessage(`âœ… æ‰«æå®Œæˆ! å‘ç° ${data.stats.totalCount} å¼ å›¾ç‰‡ã€‚`);
                        renderResults(data);
                    } else {
                        showMessage("âŒ æ‰«æå¤±è´¥: " + data.message, true);
                    }
                })
                .catch(error => {
                    scanBtn.disabled = false;
                    showMessage("âŒ è¯·æ±‚å‡ºé”™: " + error, true);
                });
        });

        // ===== åŠ è½½å†å² =====
        loadHistoryBtn.addEventListener('click', () => {
            showMessage("æ­£åœ¨åŠ è½½å†å²æ•°æ®...");
            loadHistoryBtn.disabled = true;
            hideResults();

            fetch('/api/results')
                .then(res => res.json())
                .then(data => {
                    loadHistoryBtn.disabled = false;
                    if (data.success) {
                        showMessage(`âœ… ${data.message}ï¼Œå…± ${data.stats.totalCount} æ¡è®°å½•ã€‚`);
                        renderResults(data);
                    } else {
                        showMessage("âŒ " + data.message, true);
                    }
                })
                .catch(err => {
                    loadHistoryBtn.disabled = false;
                    showMessage("âŒ è¯·æ±‚å‡ºé”™: " + err, true);
                });
        });

        // ===== å¯¼å…¥ JSON =====
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showMessage("æ­£åœ¨å¯¼å…¥...");
            hideResults();

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/results/import', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage(`âœ… ${data.message}ï¼Œå…± ${data.stats.totalCount} æ¡è®°å½•ã€‚`);
                        renderResults(data);
                    } else {
                        showMessage("âŒ " + data.message, true);
                    }
                    importFile.value = '';
                })
                .catch(err => {
                    showMessage("âŒ å¯¼å…¥å‡ºé”™: " + err, true);
                    importFile.value = '';
                });
        });

        // ===== è¡¨æ ¼æŠ˜å  =====
        toggleTableBtn.addEventListener('click', () => {
            tableWrapper.classList.toggle('collapsed');
        });

        // ===== éšè—ç»“æœåŒºåŸŸ =====
        function hideResults() {
            statsCard.style.display = 'none';
            chartsSection.style.display = 'none';
            tableCard.style.display = 'none';
        }

        // ===== æ¸²æŸ“å®Œæ•´ç»“æœ =====
        function renderResults(data) {
            const stats = data.stats;

            // ç»Ÿè®¡æ¦‚è§ˆ
            document.getElementById('totalCount').textContent = stats.totalCount;
            document.getElementById('topModel').textContent = getTopKey(stats.modelDist) || '-';
            document.getElementById('topISO').textContent = getTopKey(stats.isoDist) || '-';
            document.getElementById('topFNumber').textContent = getTopKey(stats.fNumberDist) || '-';
            statsCard.style.display = 'block';

            // å›¾è¡¨
            chartsSection.style.display = 'block';
            renderCharts(stats);

            // æ•°æ®è¡¨æ ¼
            renderTable(data.data);
            tableCard.style.display = 'block';
        }

        function getTopKey(dist) {
            if (!dist || Object.keys(dist).length === 0) return null;
            return Object.entries(dist).sort((a, b) => b[1] - a[1])[0][0];
        }

        // ===== å›¾è¡¨æ¸²æŸ“ =====
        function renderCharts(stats) {
            // é”€æ¯æ—§å›¾è¡¨
            if (modelChart) modelChart.destroy();
            if (isoChart) isoChart.destroy();
            if (fnumberChart) fnumberChart.destroy();
            if (focalChart) focalChart.destroy();

            modelChart = createPieChart('modelChart', stats.modelDist, 'ç›¸æœºå‹å·');
            isoChart = createBarChart('isoChart', stats.isoDist, 'ISO');
            fnumberChart = createBarChart('fnumberChart', stats.fNumberDist, 'å…‰åœˆ');
            focalChart = createBarChart('focalChart', stats.focalLenDist, 'ç„¦è·');
        }

        function createPieChart(canvasId, dist, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const sorted = Object.entries(dist || {}).sort((a, b) => b[1] - a[1]);
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(e => e[0]),
                    datasets: [{
                        data: sorted.map(e => e[1]),
                        backgroundColor: palette.slice(0, sorted.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });
        }

        function createBarChart(canvasId, dist, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const sorted = Object.entries(dist || {}).sort((a, b) => b[1] - a[1]);
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(e => e[0]),
                    datasets: [{
                        label: 'æ•°é‡',
                        data: sorted.map(e => e[1]),
                        backgroundColor: palette.slice(0, sorted.length),
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { maxRotation: 45, minRotation: 0 } }
                    }
                }
            });
        }

        // ===== è¡¨æ ¼æ¸²æŸ“ =====
        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">æ— æ•°æ®</td></tr>';
                return;
            }
            data.forEach(item => {
                const fileName = item.file ? item.file.split(/[/\\]/).pop() : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td title="${item.file || ''}">${fileName}</td>
                    <td>${item.exposureTime || '-'}</td>
                    <td>${item.iso || '-'}</td>
                    <td>${item.fNumber || '-'}</td>
                    <td>${item.focalLength || '-'}</td>
                    <td>${item.model || '-'}</td>
                    <td>${item.originDate || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== åˆå§‹åŒ–ï¼šåŠ è½½é…ç½®è·¯å¾„ =====
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                if (data.scan && data.scan.path) {
                    document.getElementById('scanPath').value = data.scan.path;
                }
            });

    </script>

</body>

</html>